sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","sap/ui/core/Element","sap/m/MessageToast","sap/ndc/BarcodeScanner"],function(e,o,t,a){"use strict";return e.extend("com.app.libraryapplication.controller.Details",{onInit:function(){var e=new o({title:"",author:"",genre:"",quantity:""});this.getView().setModel(e,"localModel");this.getView().byId("idBooksTable").getBinding("items");var t=new o({user:{ID:"",books:{ISBN:""}},dueDate:""});this.getView().setModel(t,"ActiveloanModel")},onAddBookButton:async function(){if(!this.oCreateBookDialog){this.oCreateBookDialog=await this.loadFragment("AddBooks");this.oCreateBookDialog1=await this.loadFragment("IssueBook");this.oActiveLoanPopUp=await this.loadFragment("ActiveLoans");this.oEditBooksDialog=await this.loadFragment("Update")}this.oCreateBookDialog.open()},onCloseCreateDialog:function(){if(this.oCreateBookDialog.isOpen()){this.oCreateBookDialog.close()}},onCloseIssueDialog:function(){if(this.oCreateBookDialog1.isOpen()){this.oCreateBookDialog1.close()}},onReservedBooksClick:async function(){if(!this.oReserveBookDialog){this.oReserveBookDialog=await this.loadFragment("ReservedBooks");this.oActiveLoanPopUp=await this.loadFragment("ActiveLoans");this.oCreateBookDialog=await this.loadFragment("AddBooks")}this.oReserveBookDialog.open();this.getView().byId("idReserveTable").getBinding("items").refresh()},onCloseReserveDialog:function(){if(this.oReserveBookDialog.isOpen()){this.oReserveBookDialog.close()}},onCreateBook:async function(){var e=this.getView();var o=e.getModel("localModel").getProperty("/");if(o.quantity){o.AvailableQuantity=o.quantity}var t=this.getView().getModel("ModelV2");try{await this.createData(t,o,"/Books");this.getView().byId("idBooksTable").getBinding("items").refresh();this.oCreateBookDialog.close();sap.m.MessageToast.show("Book Added successfully")}catch(e){this.oCreateBookDialog.close();sap.m.MessageToast.show("ISBN Should be unique")}},onDeleteBook:async function(){var e=this.byId("idBooksTable").getSelectedItem();if(e){var o=e.getBindingContext().getObject().ISBN;e.getBindingContext().delete("$auto").then(function(){sap.m.MessageToast.show(" SuccessFully Deleted")},function(e){sap.m.MessageToast.show("Deletion Error: ",e)});this.getView().byId("idBooksTable").getBinding("items").refresh()}else{sap.m.MessageToast.show("Please Select a Row to Delete")}},OnIssueBooks:async function(e){debugger;var o=this.byId("idBooksTable").getSelectedItem();var t=o.getBindingContext().getProperty("AvailableQuantity");if(t==0){sap.m.MessageBox.success("Availability stock is ZERO!!")}else{if(o){var a=o.getBindingContext().getProperty("ID")}var s=this.byId("idBooksTable").getSelectedItem().getBindingContext().getObject();console.log(s);var i=e.getSource().getParent();var n=i.getBindingContext();if(typeof s.AvailableQuantity==="number"){s.AvailableQuantity=Math.max(0,s.AvailableQuantity-1);delete s["@$ui5.context.isSelected"];var l=this.getView().getModel("ModelV2");try{await l.update("/Books("+s.ID+")",s);this.byId("idBooksTable").getBinding("items").refresh();console.log("success")}catch(e){console.error("Error updating book AvailableQuantity:",e)}}var r=new Date;var g=r.getFullYear();var d=String(r.getMonth()+1).padStart(2,"0");var c=String(r.getDate()).padStart(2,"0");var h=g+"-"+d+"-"+c;r.setDate(r.getDate()+15);var u=r.getFullYear();var B=String(r.getMonth()+1).padStart(2,"0");var v=String(r.getDate()).padStart(2,"0");var p=u+"-"+B+"-"+v;var k=new sap.ui.model.json.JSONModel({users_ID:" ",books_ID:a,duedate:p,loandate:h,Active:true,notify:`Your reserved book title "${s.title}" is issued`});this.getView().setModel(k,"newLoanModel");if(!this.oIssueBooksDialog){this.oIssueBooksDialog=await this.loadFragment("IssueBook")}this.oIssueBooksDialog.open()}},onIssueBook:async function(){const e=this.getView().getModel("newLoanModel").getProperty("/");const o=this.getView().getModel("ModelV2");try{await this.createData(o,e,"/BooksLoan");var t=this.getView().byId("idLoanTable");console.log("Dialog:",this.oIssueBooksDialog);this.oIssueBooksDialog.close();sap.m.MessageBox.success("Book Issued Successfully");this.getView().byId("idLoanTable").getBinding("items").refresh()}catch(e){console.error("Error occurred while saving:",e);sap.m.MessageBox.error("Failed to save the data. Please try again later.");console.log("Dialog:",this.oIssueBooksDialog);this.oIssueBooksDialog.close()}},onCloseIssueDialog:function(){this.getView().byId("idIssueBookDialog").close()},onCloseActiveLoans:function(){this.getView().byId("idActiveLoansDailog").close()},onActiveLoansClick:async function(){if(!this.oActiveLoanPopUp){this.oActiveLoanPopUp=await this.loadFragment("ActiveLoans");this.oReserveBookDialog=await this.loadFragment("ReservedBooks");this.oCreateBookDialog=await this.loadFragment("AddBooks")}this.oActiveLoanPopUp.open();this.getView().byId("idLoanTable").getBinding("items").refresh()},onCloseActiveLoans:function(){if(this.oActiveLoanPopUp.isOpen()){this.oActiveLoanPopUp.close()}},onUpdateButton:async function(){var e=this.byId("idBooksTable").getSelectedItems();if(e.length>0){var o=e[0];var t=o.getBindingContext();var a=t.getProperty("ID");var s=t.getProperty("ISBN");var i=t.getProperty("title");var n=t.getProperty("author");var l=t.getProperty("quantity");var r=t.getProperty("genre");var g=t.getProperty("AvailableQuantity");var d=new sap.ui.model.json.JSONModel({ID:a,author:n,title:i,quantity:l,genre:r,ISBN:s,AvailableQuantity:g});this.getView().setModel(d,"newBookModel");if(!this.oEditBooksDialog){this.oEditBooksDialog=await this.loadFragment("Update");this.oCreateBookDialog=await this.loadFragment("AddBooks")}this.oEditBooksDialog.open()}else{sap.m.MessageToast.show("Please select a book to update.")}},onCloseUpdateDialog:function(){if(this.oEditBooksDialog.isOpen()){this.oEditBooksDialog.close()}},onUpdateBook:function(){var e=this.getView().getModel("newBookModel").getData();var o=this.getOwnerComponent().getModel("ModelV2");console.log(o.getMetadata().getName());try{o.update("/Books("+e.ID+")",e,{success:function(){this.getView().byId("idBooksTable").getBinding("items").refresh();this.oEditBooksDialog.close();sap.m.MessageBox.success("Book updated successfully")}.bind(this),error:function(e){this.oEditBooksDialog.close();sap.m.MessageBox.error("ISBN number should be Unique")}.bind(this)})}catch(e){this.oEditBooksDialog.close();sap.m.MessageBox.error("Some technical Issue")}},onDeleteReserveDialog:function(){var e=this.byId("idReserveTable").getSelectedItem();if(e){var o=e.getBindingContext().getObject().sUserID;e.getBindingContext().delete("$auto").then(function(){sap.m.MessageToast.show(" SuccessFully Deleted")},function(e){sap.m.MessageToast.show("Deletion Error: ",e)});this.getView().byId("idReserveBooksDailog").getBinding("items").refresh()}else{sap.m.MessageToast.show("Please Select a Row to Delete")}},onDeleteActiveLoans:async function(){var e=this.byId("idLoanTable").getSelectedItem();if(!e){sap.m.MessageToast.show("Please select a row to delete");return}var o=e.getBindingContext();var t=o.getObject();var a=t.books.ID;var s=this.getView().getModel("ModelV2");console.log("Selected Loan:",t);if(typeof t.books.AvailableQuantity==="number"){t.books.AvailableQuantity+=1;try{await s.update(`/Books(${a})`,{AvailableQuantity:t.books.AvailableQuantity})}catch(e){console.error("Error updating book available quantity:",e);sap.m.MessageBox.error("Error updating book available quantity: "+e.message);return}}else{console.error("Available quantity is not a number.");sap.m.MessageBox.error("Available quantity is not a number.");return}try{await o.delete("$auto");this.getView().byId("idLoanTable").getBinding("items").refresh();sap.m.MessageToast.show("Loan closed successfully")}catch(e){console.error("Error deleting loan:",e);sap.m.MessageBox.error("Error deleting loan: "+e.message)}}})});